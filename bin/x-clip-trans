#!/bin/sh -e
##:
#h: Usage: x-clip-trans : Translate the text inside the clipboard.
#h:
#h: Environment variables: X_LANGUAGES
#x: Dependencies: xclip, xmessage, trans(1)
##:
x_clip_trans() {
    
    local OPTIND optopt lang
    
    ## Parse command line arguments.
    while getopts "V" optopt; do
        case $optopt in
            V)  echo "X_LANGUAGES : ${X_LANGUAGES}"; return 0;;
            \?) return 1;;
        esac
    done
    shift $(( $OPTIND - 1 ))

    ## Select language.
    lang="$(echo "${X_LANGUAGES}" | tr ',' '\n' | dmenu -l 10 -p 'Translate to:' )"
    test -n "${lang}"
    
    ## Get the text to translate.
    tmp1="$(mktemp)" tmp2="$(mktemp)" tmp3="$(mktemp)"
    xclip -selection "clipboard" -o > "${tmp1}"
    
    LANG="${lang}" trans -b "$(cat "${tmp1}")" \
        | tee "${tmp2}" \
        | xclip -selection "clipboard" -i
    cat > "${tmp3}" <<-EOF
	$(cat "${tmp2}")
	
	$(cat "${tmp1}")
	EOF
    
    ## Open with text editor.
    xmessage -nearmouse -buttons quit:0 -default quit -file "${tmp3}"
    rm -f "${tmp1}" "${tmp2}" "${tmp3}"
}


## -------------------------------------------------------------------
X_LANGUAGES="${LANG:-en_US.UTF-8}"
if test @"$(basename "$0")" = @"x-clip-trans";then
    case "${1}" in
        -h|--help) sed -n 's/^ *#h: \{0,1\}//p' "$0";;
        *)         x_clip_trans "$@"; exit 0;;
    esac
fi
